<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Upcoming Movies</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.6/dist/css/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
    <script src="https://kit.fontawesome.com/fc20eca1ac.js" crossorigin="anonymous"></script>
    <link rel="stylesheet" href="/css/main.css">
  </head>
  <body>
    <%- include("partials/navbar.ejs") %>

    <div class="container py-4">
      <div class="text-center mb-5 mt-3">
        <h1 class="border-bottom border-primary border-3 pb-1 d-inline-block">Upcoming Movies</h1>
      </div>

      <form method="GET" action="/upcoming/movies">
        <div class="row align-items-end justify-content-between">
          <div class="col-md-8 d-flex flex-wrap gap-3">
            <div>
              <select name="genre" id="genre-select" class="form-select" onchange="this.form.submit()">
                <option value="">All Genres</option>
                <!-- genre options si më parë -->
                <option value="28" <%= genre == '28' ? 'selected' : '' %>>Action</option>
                <option value="12" <%= genre == '12' ? 'selected' : '' %>>Adventure</option>
                <option value="16" <%= genre == '16' ? 'selected' : '' %>>Animation</option>
                <option value="35" <%= genre == '35' ? 'selected' : '' %>>Comedy</option>
                <option value="80" <%= genre == '80' ? 'selected' : '' %>>Crime</option>
                <option value="99" <%= genre == '99' ? 'selected' : '' %>>Documentary</option>
                <option value="18" <%= genre == '18' ? 'selected' : '' %>>Drama</option>
                <option value="10751" <%= genre == '10751' ? 'selected' : '' %>>Family</option>
                <option value="14" <%= genre == '14' ? 'selected' : '' %>>Fantasy</option>
                <option value="36" <%= genre == '36' ? 'selected' : '' %>>History</option>
                <option value="27" <%= genre == '27' ? 'selected' : '' %>>Horror</option>
                <option value="10402" <%= genre == '10402' ? 'selected' : '' %>>Music</option>
                <option value="9648" <%= genre == '9648' ? 'selected' : '' %>>Mystery</option>
                <option value="10749" <%= genre == '10749' ? 'selected' : '' %>>Romance</option>
                <option value="878" <%= genre == '878' ? 'selected' : '' %>>Science Fiction</option>
                <option value="10770" <%= genre == '10770' ? 'selected' : '' %>>TV Movie</option>
                <option value="53" <%= genre == '53' ? 'selected' : '' %>>Thriller</option>
                <option value="10752" <%= genre == '10752' ? 'selected' : '' %>>War</option>
                <option value="37" <%= genre == '37' ? 'selected' : '' %>>Western</option>
              </select>
            </div>
          </div>
          <div class="col-md-4">
            <input id="movieSearchInput" class="form-control" placeholder="Search a movie..." />
          </div>
        </div>
      </form>

      <div class="row" id="movieResults">
        <% if (!movies || movies.length === 0) { %>
          <div class="col-12">
            <p class="text-center text-muted">Movies not found!</p>
          </div>
        <% } else { %>
          <% movies.forEach(movie => { %>
            <div class="col-lg-3 col-md-6 mt-4">
              <div class="card h-100">
                <img src="https://image.tmdb.org/t/p/w500<%= movie.backdrop_path || '' %>" class="card-img-top" style="object-fit: cover; height: 180px;">
                <div class="card-body d-flex flex-column">
                  <a href="/movie/<%= movie.id %>" class="text-dark">
                    <h5 class="card-title"><%= movie.title.length > 60 ? movie.title.substring(0, 57) + "..." : movie.title %></h5>
                  </a>
                  <p class="card-text"><%= movie.overview ? (movie.overview.length > 80 ? movie.overview.substring(0, 77) + "..." : movie.overview) : "No Description" %></p>
                  
                  <% if (movie.vote_average >= 0.0 && movie.vote_average <= 1.0) { %>
                      <p class="mb-0 mt-3">
                        <small class="text-secondary">Average Rating:</small>
                        <i class="fa-solid fa-star-half-stroke" style="color: #FFD43B;"></i>
                      </p>
                    <% } %>

                    <% if (movie.vote_average >= 1.0 && movie.vote_average <= 1.9) { %>
                      <p class="mb-0 mt-3">
                        <small class="text-secondary">Average Rating:</small>
                        <i class="fa-solid fa-star" style="color: #FFD43B;"></i>
                      </p>
                    <% } %>

                    <% if (movie.vote_average >= 2.0 && movie.vote_average <= 2.4) { %>
                      <p class="mb-0 mt-3">
                        <small class="text-secondary">Average Rating:</small>
                        <i class="fa-solid fa-star" style="color: #FFD43B;"></i>
                        <i class="fa-solid fa-star-half-stroke" style="color: #FFD43B;"></i> 
                      </p>
                    <% } %>

                    <% if (movie.vote_average >= 2.5 && movie.vote_average <= 2.9) { %>
                      <p class="mb-0 mt-3">
                        <small class="text-secondary">Average Rating:</small>
                          <i class="fa-solid fa-star" style="color: #FFD43B;"></i>
                          <i class="fa-solid fa-star" style="color: #FFD43B;"></i>
                      </p>
                    <% } %>


                    <% if (movie.vote_average >= 3.0 && movie.vote_average <= 3.4) { %>
                      <p class="mb-0 mt-3">
                        <small class="text-secondary">Average Rating:</small>
                          <i class="fa-solid fa-star" style="color: #FFD43B;"></i>
                          <i class="fa-solid fa-star-half-stroke" style="color: #FFD43B;"></i>
                      </p>
                    <% } %>

                    <% if (movie.vote_average >= 3.5 && movie.vote_average <= 3.9) { %>
                      <p class="mb-0 mt-3">
                        <small class="text-secondary">Average Rating:</small>
                        <i class="fa-solid fa-star" style="color: #FFD43B;"></i>
                        <i class="fa-solid fa-star" style="color: #FFD43B;"></i>
                        <i class="fa-solid fa-star" style="color: #FFD43B;"></i>
                      </p>
                    <% } %>

                    <% if (movie.vote_average >= 4.0 && movie.vote_average <= 4.4) { %>
                      <p class="mb-0 mt-3">
                        <small class="text-secondary">Average Rating:</small>
                        <i class="fa-solid fa-star" style="color: #FFD43B;"></i>
                        <i class="fa-solid fa-star" style="color: #FFD43B;"></i>
                        <i class="fa-solid fa-star" style="color: #FFD43B;"></i>
                        <i class="fa-solid fa-star-half-stroke" style="color: #FFD43B;"></i>
                      </p>
                    <% } %>

                    <% if (movie.vote_average >= 4.5 && movie.vote_average <= 4.9) { %>
                      <p class="mb-0 mt-3">
                        <small class="text-secondary">Average Rating:</small>
                        <i class="fa-solid fa-star" style="color: #FFD43B;"></i>
                        <i class="fa-solid fa-star" style="color: #FFD43B;"></i>
                        <i class="fa-solid fa-star" style="color: #FFD43B;"></i>
                        <i class="fa-solid fa-star" style="color: #FFD43B;"></i>
                      </p>
                    <% } %>

                    <% if( movie.vote_average >= 5.0) { %>
                      <p class="mb-0 mt-3">
                        <small class="text-secondary">Average Rating:</small>
                        <i class="fa-solid fa-star" style="color: #FFD43B;"></i>
                        <i class="fa-solid fa-star" style="color: #FFD43B;"></i>
                        <i class="fa-solid fa-star" style="color: #FFD43B;"></i>
                        <i class="fa-solid fa-star" style="color: #FFD43B;"></i>
                        <i class="fa-solid fa-star" style="color: #FFD43B;"></i>
                      </p>
                    <% } %>
                  
                  <p class="mb-2"><small class="text-secondary">Release Date: <%= movie.release_date || "Unknown" %></small></p>
                  <a href="/movie/<%= movie.id %>" class="btn btn-primary">Read More</a>
                </div>
              </div>
            </div>
          <% }) %>
        <% } %>
      </div>

      <div class="d-flex justify-content-between">
        <p class="mb-0"><small class="text-secondary">Total Movies: <%= totalMovies %></small></p>
        <p class="mb-0"><small class="text-secondary">Movies per page: <%= movies.length %></small></p>
      </div>

      <% if (totalPages > 1) { %>
        <ul class="pagination justify-content-center mt-4">
          <li class="page-item <%= currentPage === 1 ? 'disabled' : '' %>">
            <a class="page-link" href="/upcoming/movies?genre=<%= genre || '' %>&page=<%= currentPage - 1 %>">Previous</a>
          </li>
          <% for (let i = 1; i <= totalPages; i++) { %>
            <li class="page-item <%= i === currentPage ? 'active' : '' %>">
              <a class="page-link" href="/upcoming/movies?genre=<%= genre || '' %>&page=<%= i %>"><%= i %></a>
            </li>
          <% } %>
          <li class="page-item <%= currentPage === totalPages ? 'disabled' : '' %>">
            <a class="page-link" href="/upcoming/movies?genre=<%= genre || '' %>&page=<%= currentPage + 1 %>">Next</a>
          </li>
        </ul>
      <% } %>
    </div>
    <script src="/js/script.js"></script>
    <script>
      const input = document.getElementById("movieSearchInput");
      const movieResults = document.getElementById("movieResults");

      input.addEventListener("input", async () => {
        const keyword = input.value.trim();
        const genre = document.getElementById("genre-select").value;

        const query = keyword.length === 0 ? "a" : keyword;
        const res = await fetch(`/upcoming/movies/search?q=${encodeURIComponent(query)}&genre=${encodeURIComponent(genre)}`);
        const results = await res.json();

        movieResults.innerHTML = results.map(movie => `
          <div class="col-lg-3 col-md-6 mt-4">
            <div class="card h-100">
              <img src="https://image.tmdb.org/t/p/w500${movie.backdrop_path || ''}" class="card-img-top" style="object-fit: cover; height: 180px;">
              <div class="card-body d-flex flex-column">
                <a href="/movie/${movie.id}" class="text-dark">
                  <h5 class="card-title">${movie.title.length > 60 ? movie.title.substring(0, 57) + "..." : movie.title}</h5>
                </a>
                <p class="card-text">${movie.overview ? (movie.overview.length > 80 ? movie.overview.substring(0, 77) + "..." : movie.overview) : "No Description"}</p>
                <p class="mb-2"><small class="text-secondary">Release Date: ${movie.release_date || "Unknown"}</small></p>
                <a href="#" class="btn btn-primary mb-3 mt-auto">Add to favorites</a>
                <a href="#" class="btn btn-outline-primary">Add to watched list</a>
              </div>
            </div>
          </div>
        `).join("");
      });
    </script>
  </body>
</html>
